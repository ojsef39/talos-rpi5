From be19355287eef8688658bbf3a1d3c73cc5ed267c Mon Sep 17 00:00:00 2001
From: Josef Hofer <me@jhofer.de>
Date: Sat, 14 Feb 2026 21:56:31 +0100
Subject: [PATCH] Patched for Raspberry Pi 5

---
 Makefile                                      |  14 +--
 hack/modules-arm64.txt                        | 106 +++++++++++++++---
 .../runtime/v1alpha2/v1alpha2_controller.go   |  33 +++---
 3 files changed, 113 insertions(+), 40 deletions(-)

diff --git a/Makefile b/Makefile
index 996349b45..023e09503 100644
--- a/Makefile
+++ b/Makefile
@@ -328,10 +328,10 @@ local-%: ## Builds the specified target defined in the Dockerfile using the loca
 
 docker-%: ## Builds the specified target defined in the Dockerfile using the docker output type. The build result will be output to the specified local destination.
 	@mkdir -p $(DEST)
-	@$(MAKE) target-$* TARGET_ARGS="--output type=docker,dest=$(DEST)/$*.tar,name=$(REGISTRY_AND_USERNAME)/$*:$(IMAGE_TAG_OUT) $(TARGET_ARGS)"
+	@$(MAKE) target-$* TARGET_ARGS="--output type=docker,dest=$(DEST)/$*.tar,name=$(REGISTRY_AND_USERNAME)/talos-rpi5-$*:$(IMAGE_TAG_OUT) $(TARGET_ARGS)"
 
 registry-%: ## Builds the specified target defined in the Dockerfile using the image/registry output type. The build result will be pushed to the registry if PUSH=true.
-	@$(MAKE) target-$* TARGET_ARGS="--output type=image,name=$(REGISTRY_AND_USERNAME)/$*:$(IMAGE_TAG_OUT),rewrite-timestamp=true $(TARGET_ARGS)"
+	@$(MAKE) target-$* TARGET_ARGS="--output type=image,name=$(REGISTRY_AND_USERNAME)/talos-rpi5-$*:$(IMAGE_TAG_OUT),rewrite-timestamp=true $(TARGET_ARGS)"
 
 hack-test-%: ## Runs the specified script in ./hack/test with well known environment variables.
 	@./hack/test/$*.sh
@@ -423,10 +423,10 @@ sbom:
 	@$(MAKE) local-sbom DEST=$(ARTIFACTS)
 
 image-%: ## Builds the specified image. Valid options are aws, azure, digital-ocean, gcp, and vmware (e.g. image-aws)
-	@docker pull $(REGISTRY_AND_USERNAME)/imager:$(IMAGE_TAG_IN)
+	@docker pull $(REGISTRY_AND_USERNAME)/talos-rpi5-imager:$(IMAGE_TAG_IN)
 	@for platform in $(subst $(,),$(space),$(PLATFORM)); do \
 		arch=$$(basename "$${platform}") && \
-		docker run --rm -t -e GITHUB_TOKEN -v /dev:/dev -v $(PWD)/$(ARTIFACTS):/secureboot:ro -v $(PWD)/$(ARTIFACTS):/out -e SOURCE_DATE_EPOCH=$(SOURCE_DATE_EPOCH) --network=host --privileged $(REGISTRY_AND_USERNAME)/imager:$(IMAGE_TAG_IN) $* --arch $$arch --base-installer-image $(REGISTRY_AND_USERNAME)/installer-base:$(IMAGE_TAG_IN) $(IMAGER_ARGS) ; \
+		docker run --rm -t -e GITHUB_TOKEN -v /dev:/dev -v $(PWD)/$(ARTIFACTS):/secureboot:ro -v $(PWD)/$(ARTIFACTS):/out -e SOURCE_DATE_EPOCH=$(SOURCE_DATE_EPOCH) --network=host --privileged $(REGISTRY_AND_USERNAME)/talos-rpi5-imager:$(IMAGE_TAG_IN) $* --arch $$arch --base-installer-image $(REGISTRY_AND_USERNAME)/talos-rpi5-installer-base:$(IMAGE_TAG_IN) $(IMAGER_ARGS) ; \
 	done
 
 .PHONY: images-essential
@@ -445,16 +445,16 @@ IMAGES_LIST :=
 
 .PHONY: installer
 installer: ## Builds the installer and outputs it to the artifact directory.
-	@$(MAKE) image-installer IMAGER_ARGS="--base-installer-image $(REGISTRY_AND_USERNAME)/installer-base:$(IMAGE_TAG_IN) $(IMAGER_ARGS)"
+	@$(MAKE) image-installer IMAGER_ARGS="--base-installer-image $(REGISTRY_AND_USERNAME)/talos-rpi5-installer-base:$(IMAGE_TAG_IN) $(IMAGER_ARGS)"
 
 	@crane_args=""
 	@for platform in $(subst $(,),$(space),$(PLATFORM)); do \
 		arch=$$(basename "$${platform}") && \
-		image=$$(crane push $(ARTIFACTS)/installer-$${arch}.tar $(REGISTRY_AND_USERNAME)/installer:$(IMAGE_TAG_OUT)-$${arch}) && \
+		image=$$(crane push $(ARTIFACTS)/installer-$${arch}.tar $(REGISTRY_AND_USERNAME)/talos-rpi5-installer:$(IMAGE_TAG_OUT)-$${arch}) && \
 		crane_args="$${crane_args} -m $${image}" && \
 		rm -f $(ARTIFACTS)/installer-$${arch}.tar ; \
 	done; \
-	crane index append -t "${REGISTRY_AND_USERNAME}/installer:${IMAGE_TAG_OUT}" $${crane_args}
+	crane index append -t "${REGISTRY_AND_USERNAME}/talos-rpi5-installer:${IMAGE_TAG_OUT}" $${crane_args}
 
 
 .PHONY: secureboot-installer
diff --git a/hack/modules-arm64.txt b/hack/modules-arm64.txt
index 8df29effd..b91c79774 100644
--- a/hack/modules-arm64.txt
+++ b/hack/modules-arm64.txt
@@ -1,11 +1,26 @@
+modules.alias
+modules.alias.bin
+modules.builtin
+modules.builtin.alias.bin
+modules.builtin.bin
+modules.builtin.modinfo
+modules.dep
+modules.dep.bin
+modules.devname
+modules.order
+modules.softdep
+modules.symbols
+modules.symbols.bin
+modules.weakdep
 kernel/arch/arm64/lib/xor-neon.ko
 kernel/crypto/async_tx/async_memcpy.ko
 kernel/crypto/async_tx/async_pq.ko
 kernel/crypto/async_tx/async_raid6_recov.ko
 kernel/crypto/async_tx/async_tx.ko
 kernel/crypto/async_tx/async_xor.ko
-kernel/crypto/hkdf.ko
+kernel/crypto/blake2b_generic.ko
 kernel/crypto/xor.ko
+kernel/crypto/xxhash_generic.ko
 kernel/drivers/acpi/video.ko
 kernel/drivers/ata/ahci.ko
 kernel/drivers/ata/pata_amd.ko
@@ -15,17 +30,24 @@ kernel/drivers/ata/pata_sch.ko
 kernel/drivers/block/nbd.ko
 kernel/drivers/block/ublk_drv.ko
 kernel/drivers/crypto/tegra/tegra-se.ko
+kernel/drivers/dma/bcm-sba-raid.ko
+kernel/drivers/gpu/drm/amd/amdgpu/amdgpu.ko
+kernel/drivers/gpu/drm/amd/amdxcp/amdxcp.ko
+kernel/drivers/gpu/drm/display/drm_dp_aux_bus.ko
 kernel/drivers/gpu/drm/drm_buddy.ko
 kernel/drivers/gpu/drm/drm_exec.ko
 kernel/drivers/gpu/drm/drm_gpuvm.ko
-kernel/drivers/gpu/drm/drm_panel_backlight_quirks.ko
 kernel/drivers/gpu/drm/drm_suballoc_helper.ko
 kernel/drivers/gpu/drm/drm_ttm_helper.ko
 kernel/drivers/gpu/drm/drm_vram_helper.ko
 kernel/drivers/gpu/drm/hisilicon/hibmc/hibmc-drm.ko
+kernel/drivers/gpu/drm/panfrost/panfrost.ko
+kernel/drivers/gpu/drm/panthor/panthor.ko
 kernel/drivers/gpu/drm/scheduler/gpu-sched.ko
 kernel/drivers/gpu/drm/tegra/tegra-drm.ko
 kernel/drivers/gpu/drm/ttm/ttm.ko
+kernel/drivers/gpu/drm/v3d/v3d.ko
+kernel/drivers/gpu/drm/vc4/vc4.ko
 kernel/drivers/gpu/host1x/host1x.ko
 kernel/drivers/hid/hid-a4tech.ko
 kernel/drivers/hid/hid-apple.ko
@@ -58,7 +80,7 @@ kernel/drivers/infiniband/hw/irdma/irdma.ko
 kernel/drivers/infiniband/hw/mlx4/mlx4_ib.ko
 kernel/drivers/infiniband/hw/mlx5/mlx5_ib.ko
 kernel/drivers/infiniband/sw/rxe/rdma_rxe.ko
-kernel/drivers/irqchip/irq-bcm2712-mip.ko
+kernel/drivers/input/misc/uinput.ko
 kernel/drivers/irqchip/irq-imx-mu-msi.ko
 kernel/drivers/leds/led-class-multicolor.ko
 kernel/drivers/mailbox/bcm-flexrm-mailbox.ko
@@ -66,13 +88,22 @@ kernel/drivers/md/bcache/bcache.ko
 kernel/drivers/md/dm-bio-prison.ko
 kernel/drivers/md/dm-cache-smq.ko
 kernel/drivers/md/dm-cache.ko
-kernel/drivers/md/dm-integrity.ko
 kernel/drivers/md/dm-multipath.ko
 kernel/drivers/md/dm-raid.ko
 kernel/drivers/md/dm-round-robin.ko
 kernel/drivers/md/dm-thin-pool.ko
 kernel/drivers/md/persistent-data/dm-persistent-data.ko
 kernel/drivers/md/raid456.ko
+kernel/drivers/media/common/uvc.ko
+kernel/drivers/media/common/videobuf2/videobuf2-common.ko
+kernel/drivers/media/common/videobuf2/videobuf2-memops.ko
+kernel/drivers/media/common/videobuf2/videobuf2-v4l2.ko
+kernel/drivers/media/common/videobuf2/videobuf2-vmalloc.ko
+kernel/drivers/media/mc/mc.ko
+kernel/drivers/media/usb/uvc/uvcvideo.ko
+kernel/drivers/media/v4l2-core/v4l2-dv-timings.ko
+kernel/drivers/media/v4l2-core/videodev.ko
+kernel/drivers/misc/bcm2835_smi.ko
 kernel/drivers/misc/hpilo.ko
 kernel/drivers/mmc/host/sdhci_f_sdh30.ko
 kernel/drivers/mmc/host/sdhci-acpi.ko
@@ -86,7 +117,6 @@ kernel/drivers/mmc/host/sdhci-of-esdhc.ko
 kernel/drivers/mmc/host/sdhci-pci.ko
 kernel/drivers/mmc/host/sdhci-pltfm.ko
 kernel/drivers/mmc/host/sdhci-tegra.ko
-kernel/drivers/mmc/host/sdhci-uhs2.ko
 kernel/drivers/mmc/host/sdhci-xenon-driver.ko
 kernel/drivers/net/ethernet/amazon/ena/ena.ko
 kernel/drivers/net/ethernet/aquantia/atlantic/atlantic.ko
@@ -96,6 +126,11 @@ kernel/drivers/net/ethernet/broadcom/bnx2x/bnx2x.ko
 kernel/drivers/net/ethernet/broadcom/bnxt/bnxt_en.ko
 kernel/drivers/net/ethernet/broadcom/tg3.ko
 kernel/drivers/net/ethernet/cavium/common/cavium_ptp.ko
+kernel/drivers/net/ethernet/chelsio/cxgb/cxgb.ko
+kernel/drivers/net/ethernet/chelsio/cxgb3/cxgb3.ko
+kernel/drivers/net/ethernet/chelsio/cxgb4/cxgb4.ko
+kernel/drivers/net/ethernet/chelsio/cxgb4vf/cxgb4vf.ko
+kernel/drivers/net/ethernet/chelsio/inline_crypto/ch_ipsec/ch_ipsec.ko
 kernel/drivers/net/ethernet/cisco/enic/enic.ko
 kernel/drivers/net/ethernet/google/gve/gve.ko
 kernel/drivers/net/ethernet/hisilicon/hip04_eth.ko
@@ -116,16 +151,12 @@ kernel/drivers/net/ethernet/intel/e1000e/e1000e.ko
 kernel/drivers/net/ethernet/intel/i40e/i40e.ko
 kernel/drivers/net/ethernet/intel/iavf/iavf.ko
 kernel/drivers/net/ethernet/intel/ice/ice.ko
-kernel/drivers/net/ethernet/intel/idpf/idpf.ko
 kernel/drivers/net/ethernet/intel/igb/igb.ko
 kernel/drivers/net/ethernet/intel/igbvf/igbvf.ko
 kernel/drivers/net/ethernet/intel/igc/igc.ko
 kernel/drivers/net/ethernet/intel/ixgbe/ixgbe.ko
 kernel/drivers/net/ethernet/intel/ixgbevf/ixgbevf.ko
-kernel/drivers/net/ethernet/intel/libeth/libeth_xdp.ko
 kernel/drivers/net/ethernet/intel/libeth/libeth.ko
-kernel/drivers/net/ethernet/intel/libie/libie_adminq.ko
-kernel/drivers/net/ethernet/intel/libie/libie_fwlog.ko
 kernel/drivers/net/ethernet/intel/libie/libie.ko
 kernel/drivers/net/ethernet/marvell/sky2.ko
 kernel/drivers/net/ethernet/mellanox/mlx4/mlx4_core.ko
@@ -151,7 +182,6 @@ kernel/drivers/net/ethernet/stmicro/stmmac/dwmac-ipq806x.ko
 kernel/drivers/net/ethernet/stmicro/stmmac/dwmac-meson.ko
 kernel/drivers/net/ethernet/stmicro/stmmac/dwmac-meson8b.ko
 kernel/drivers/net/ethernet/stmicro/stmmac/dwmac-qcom-ethqos.ko
-kernel/drivers/net/ethernet/stmicro/stmmac/dwmac-renesas-gbeth.ko
 kernel/drivers/net/ethernet/stmicro/stmmac/dwmac-rk.ko
 kernel/drivers/net/ethernet/stmicro/stmmac/dwmac-sun8i.ko
 kernel/drivers/net/ethernet/stmicro/stmmac/dwmac-sunxi.ko
@@ -160,14 +190,46 @@ kernel/drivers/net/ethernet/stmicro/stmmac/stmmac-pci.ko
 kernel/drivers/net/ethernet/stmicro/stmmac/stmmac-platform.ko
 kernel/drivers/net/ethernet/stmicro/stmmac/stmmac.ko
 kernel/drivers/net/mdio.ko
+kernel/drivers/net/mdio/mdio-mux-meson-gxl.ko
 kernel/drivers/net/pcs/pcs_xpcs.ko
+kernel/drivers/net/phy/ax88796b.ko
 kernel/drivers/net/phy/dp83867.ko
+kernel/drivers/net/thunderbolt/thunderbolt_net.ko
+kernel/drivers/net/usb/aqc111.ko
+kernel/drivers/net/usb/asix.ko
+kernel/drivers/net/usb/ax88179_178a.ko
+kernel/drivers/net/usb/cdc_eem.ko
+kernel/drivers/net/usb/cdc_ether.ko
+kernel/drivers/net/usb/cdc_mbim.ko
+kernel/drivers/net/usb/cdc_ncm.ko
+kernel/drivers/net/usb/cdc_subset.ko
+kernel/drivers/net/usb/cdc-phonet.ko
+kernel/drivers/net/usb/ch9200.ko
+kernel/drivers/net/usb/cx82310_eth.ko
+kernel/drivers/net/usb/dm9601.ko
+kernel/drivers/net/usb/gl620a.ko
+kernel/drivers/net/usb/huawei_cdc_ncm.ko
+kernel/drivers/net/usb/int51x1.ko
+kernel/drivers/net/usb/kalmia.ko
+kernel/drivers/net/usb/lg-vl600.ko
+kernel/drivers/net/usb/mcs7830.ko
+kernel/drivers/net/usb/net1080.ko
+kernel/drivers/net/usb/plusb.ko
+kernel/drivers/net/usb/qmi_wwan.ko
 kernel/drivers/net/usb/r8152.ko
+kernel/drivers/net/usb/r8153_ecm.ko
+kernel/drivers/net/usb/rndis_host.ko
+kernel/drivers/net/usb/sierra_net.ko
+kernel/drivers/net/usb/smsc75xx.ko
+kernel/drivers/net/usb/smsc95xx.ko
+kernel/drivers/net/usb/sr9700.ko
+kernel/drivers/net/usb/sr9800.ko
+kernel/drivers/net/usb/usbnet.ko
+kernel/drivers/net/usb/zaurus.ko
 kernel/drivers/net/vmxnet3/vmxnet3.ko
 kernel/drivers/net/vrf.ko
 kernel/drivers/nvme/common/nvme-auth.ko
 kernel/drivers/nvme/host/nvme-rdma.ko
-kernel/drivers/nvme/host/nvme.ko
 kernel/drivers/nvme/target/nvme-loop.ko
 kernel/drivers/nvme/target/nvmet-fc.ko
 kernel/drivers/nvme/target/nvmet-rdma.ko
@@ -197,12 +259,16 @@ kernel/drivers/scsi/mpt3sas/mpt3sas.ko
 kernel/drivers/scsi/qedf/qedf.ko
 kernel/drivers/scsi/qla2xxx/qla2xxx.ko
 kernel/drivers/scsi/smartpqi/smartpqi.ko
+kernel/drivers/thunderbolt/thunderbolt.ko
 kernel/drivers/uio/uio_pci_generic.ko
 kernel/drivers/uio/uio.ko
+kernel/drivers/usb/class/cdc-wdm.ko
 kernel/drivers/usb/serial/ch341.ko
 kernel/drivers/usb/serial/cp210x.ko
 kernel/drivers/usb/serial/ftdi_sio.ko
+kernel/drivers/usb/serial/option.ko
 kernel/drivers/usb/serial/pl2303.ko
+kernel/drivers/usb/serial/usb_wwan.ko
 kernel/drivers/vdpa/mlx5/mlx5_vdpa.ko
 kernel/drivers/vdpa/octeon_ep/octep_vdpa.ko
 kernel/drivers/vdpa/solidrun/snet_vdpa.ko
@@ -226,13 +292,23 @@ kernel/drivers/virtio/virtio_pci_modern_dev.ko
 kernel/drivers/virtio/virtio_pci.ko
 kernel/drivers/virtio/virtio_vdpa.ko
 kernel/drivers/watchdog/sbsa_gwdt.ko
+kernel/fs/binfmt_misc.ko
+kernel/fs/btrfs/btrfs.ko
+kernel/fs/nfsd/nfsd.ko
 kernel/lib/objagg.ko
 kernel/lib/parman.ko
 kernel/lib/raid6/raid6_pq.ko
 kernel/net/ipv4/ip_gre.ko
-kernel/net/ipv6/ip6_gre.ko
 kernel/net/openvswitch/vport-gre.ko
 kernel/net/tls/tls.ko
-modules.builtin
-modules.builtin.modinfo
-modules.order
+kernel/sound/core/snd-hwdep.ko
+kernel/sound/core/snd-pcm-dmaengine.ko
+kernel/sound/core/snd-pcm.ko
+kernel/sound/core/snd-rawmidi.ko
+kernel/sound/core/snd-timer.ko
+kernel/sound/core/snd.ko
+kernel/sound/soc/codecs/snd-soc-hdmi-codec.ko
+kernel/sound/soc/snd-soc-core.ko
+kernel/sound/soundcore.ko
+kernel/sound/usb/snd-usb-audio.ko
+kernel/sound/usb/snd-usbmidi-lib.ko
diff --git a/internal/app/machined/pkg/runtime/v1alpha2/v1alpha2_controller.go b/internal/app/machined/pkg/runtime/v1alpha2/v1alpha2_controller.go
index 29b297654..80ea743a4 100644
--- a/internal/app/machined/pkg/runtime/v1alpha2/v1alpha2_controller.go
+++ b/internal/app/machined/pkg/runtime/v1alpha2/v1alpha2_controller.go
@@ -113,27 +113,24 @@ func (ctrl *Controller) Run(ctx context.Context, drainer *runtime.Drainer) error
 
 	networkBindMountTarget = constants.SystemResolvedPath
 
-	// While running in container, we don't have control over kernel version
-	// shipped with the machine. If the kernel does not support open_tree syscall
-	// on anonymous filesystem file descriptors, we need to fallback to the classic,
-	// less secure mode. This capability was added in kernel 6.15.0.
-	if ctrl.v1alpha1Runtime.State().Platform().Mode().InContainer() {
-		opentreeOnAnonymous, err := runtime.KernelCapabilities().OpentreeOnAnonymousFS()
-		if err != nil {
-			return err
-		}
-
-		if !opentreeOnAnonymous {
-			etcRoot = &xfs.OSRoot{
-				Shadow: constants.SystemEtcPath,
-			}
+	// If the kernel does not support open_tree syscall on anonymous filesystem
+	// file descriptors, we need to fallback to the classic, less secure mode.
+	// This capability was added in kernel 6.15.0.
+	opentreeOnAnonymous, err := runtime.KernelCapabilities().OpentreeOnAnonymousFS()
+	if err != nil {
+		return err
+	}
 
-			networkEtcRoot = &xfs.OSRoot{
-				Shadow: constants.SystemResolvedPath,
-			}
+	if !opentreeOnAnonymous {
+		etcRoot = &xfs.OSRoot{
+			Shadow: constants.SystemEtcPath,
+		}
 
-			networkBindMountTarget = ""
+		networkEtcRoot = &xfs.OSRoot{
+			Shadow: constants.SystemResolvedPath,
 		}
+
+		networkBindMountTarget = ""
 	}
 
 	if err := etcRoot.OpenFS(); err != nil {
-- 
2.52.0

