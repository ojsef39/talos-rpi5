From f3b86df1e694ec8d00e7d1400fbea43ca80cca4a Mon Sep 17 00:00:00 2001
From: Josef Hofer <me@jhofer.de>
Date: Sat, 14 Feb 2026 20:55:55 +0100
Subject: [PATCH] Patched for Raspberry Pi 5

---
 Makefile                  |  8 +++++---
 Pkgfile                   |  8 ++++----
 kernel/build/config-arm64 | 35 ++++++++++++++++++++++++++---------
 kernel/prepare/pkg.yaml   |  6 +++---
 4 files changed, 38 insertions(+), 19 deletions(-)

diff --git a/Makefile b/Makefile
index bd3d1cb..824a6d8 100644
--- a/Makefile
+++ b/Makefile
@@ -15,6 +15,7 @@ GOARCH := $(shell uname -m | sed 's/x86_64/amd64/' | sed 's/aarch64/arm64/')
 REGISTRY ?= ghcr.io
 USERNAME ?= siderolabs
 REGISTRY_AND_USERNAME ?= $(REGISTRY)/$(USERNAME)
+PKG_PREFIX ?=
 KRES_IMAGE ?= ghcr.io/siderolabs/kres:latest
 CONFORMANCE_IMAGE ?= ghcr.io/siderolabs/conform:latest
 
@@ -27,11 +28,12 @@ SOURCE_DATE_EPOCH := $(shell git log $(INITIAL_COMMIT_SHA) --pretty=%ct)
 
 BLDR_RELEASE := v0.5.5
 BLDR_IMAGE := ghcr.io/siderolabs/bldr:$(BLDR_RELEASE)
-BLDR := docker run --rm --user $(shell id -u):$(shell id -g) --volume $(PWD):/src --entrypoint=/bldr $(BLDR_IMAGE) --root=/src
+BLDR := $(CONTAINER_RUNTIME) run --rm --user $(shell id -u):$(shell id -g) --volume $(PWD):/src --entrypoint=/bldr $(BLDR_IMAGE) --root=/src
 
 # docker build settings
 
-BUILD := docker buildx build
+CONTAINER_RUNTIME ?= $(shell command -v docker 2>/dev/null || command -v podman 2>/dev/null || echo docker)
+BUILD := $(CONTAINER_RUNTIME) buildx build
 PLATFORM ?= linux/amd64,linux/arm64
 PROGRESS ?= auto
 PUSH ?= false
@@ -203,7 +205,7 @@ nonfree: $(NONFREE_TARGETS)  ## Builds all nonfree targets defined.
 
 .PHONY: $(TARGETS) $(NONFREE_TARGETS)
 $(TARGETS) $(NONFREE_TARGETS):
-	@$(MAKE) docker-$@ TARGET_ARGS="--tag=$(REGISTRY_AND_USERNAME)/$@:$(TAG) --push=$(PUSH)"
+	@$(MAKE) docker-$@ TARGET_ARGS="--tag=$(REGISTRY_AND_USERNAME)/$(PKG_PREFIX)$@:$(TAG) --push=$(PUSH)"
 
 .PHONY: deps.svg
 deps.svg:  ## Generates a dependency graph of the Pkgfile.
diff --git a/Pkgfile b/Pkgfile
index 8799e13..94e64ea 100644
--- a/Pkgfile
+++ b/Pkgfile
@@ -91,10 +91,10 @@ vars:
   kspp_sha256: 3e5f3ea80c6e82afd5550211d240daabf0676e900ca651b3a207c6946e04521d
   kspp_sha512: 6ca9521dc15a5897b490a6e2a3e262f09922f0cbf03e1abba4819f9bdee36e2f08fb5acd7c6cb49d50fcd323cdf571222da42f934fa7d8f55c4fa69be5b2b545
 
-  # renovate: datasource=git-tags extractVersion=^v(?<version>.*)$ depName=git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git
-  linux_version: 6.17.7
-  linux_sha256: ddf2ea0d4439e1d57136be3623102af9458f601f5b1cb77e83246e88aea09d0e
-  linux_sha512: f16f28c395374099ccf21d9df654a31746ed3f09376f7f9eca172579787b7b493d3878cb0a44348c2846bba93f7950f04b0e45235152860e4789fdd2aa9711cb
+  # renovate: datasource=git-tags extractVersion=^v(?<version>.*)$ depName=https://github.com/raspberrypi/linux.git
+  linux_version: stable_20250916
+  linux_sha256: 4639fe79697970b71cf708234b71d855a58ce5e28c377a4f7cf6ecbbe40647f3
+  linux_sha512: 5818d7ac495dc31a27c9b967bf146d291ab6fd06b99e819d9c685d5413472593cd99a4d7ce10218c45d7fb631adceed8e20806b1f2f9909277ce0de7ad204565
 
   # renovate: datasource=git-tags extractVersion=^libaio-(?<version>.*)$ depName=https://pagure.io/libaio.git
   libaio_version: 0.3.113
diff --git a/kernel/build/config-arm64 b/kernel/build/config-arm64
index 65b3647..132b2b5 100644
--- a/kernel/build/config-arm64
+++ b/kernel/build/config-arm64
@@ -450,8 +450,8 @@ CONFIG_ROCKCHIP_ERRATUM_3588001=y
 CONFIG_SOCIONEXT_SYNQUACER_PREITS=y
 # end of ARM errata workarounds via the alternatives framework
 
-CONFIG_ARM64_4K_PAGES=y
-# CONFIG_ARM64_16K_PAGES is not set
+# CONFIG_ARM64_4K_PAGES is not set
+CONFIG_ARM64_16K_PAGES=y
 # CONFIG_ARM64_64K_PAGES is not set
 # CONFIG_ARM64_VA_BITS_39 is not set
 CONFIG_ARM64_VA_BITS_48=y
@@ -660,7 +660,7 @@ CONFIG_CPU_FREQ_STAT=y
 # CONFIG_CPU_FREQ_DEFAULT_GOV_PERFORMANCE is not set
 # CONFIG_CPU_FREQ_DEFAULT_GOV_POWERSAVE is not set
 # CONFIG_CPU_FREQ_DEFAULT_GOV_USERSPACE is not set
-# CONFIG_CPU_FREQ_DEFAULT_GOV_ONDEMAND is not set
+CONFIG_CPU_FREQ_DEFAULT_GOV_ONDEMAND=y
 # CONFIG_CPU_FREQ_DEFAULT_GOV_CONSERVATIVE is not set
 CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
 CONFIG_CPU_FREQ_GOV_PERFORMANCE=y
@@ -1369,7 +1369,7 @@ CONFIG_NETLABEL=y
 # CONFIG_MPTCP is not set
 CONFIG_NETWORK_SECMARK=y
 CONFIG_NET_PTP_CLASSIFY=y
-# CONFIG_NETWORK_PHY_TIMESTAMPING is not set
+CONFIG_NETWORK_PHY_TIMESTAMPING=y
 CONFIG_NETFILTER=y
 CONFIG_NETFILTER_ADVANCED=y
 CONFIG_BRIDGE_NETFILTER=y
@@ -2263,6 +2263,7 @@ CONFIG_IMX_SCMI_LMM_DRV=y
 CONFIG_IMX_SCMI_MISC_DRV=y
 CONFIG_MESON_SM=y
 CONFIG_ARM_PSCI_FW=y
+CONFIG_FIRMWARE_RP1=y
 # CONFIG_ARM_PSCI_CHECKER is not set
 
 #
@@ -2445,7 +2446,7 @@ CONFIG_BLK_DEV_UBLK=m
 #
 CONFIG_NVME_AUTH=m
 CONFIG_NVME_CORE=y
-CONFIG_BLK_DEV_NVME=m
+CONFIG_BLK_DEV_NVME=y
 CONFIG_NVME_MULTIPATH=y
 # CONFIG_NVME_VERBOSE_ERRORS is not set
 CONFIG_NVME_HWMON=y
@@ -2471,6 +2472,8 @@ CONFIG_NVME_TARGET_AUTH=y
 #
 # Misc devices
 #
+CONFIG_RP1_PIO=y
+CONFIG_WS2812_PIO_RP1=y
 # CONFIG_AD525X_DPOT is not set
 # CONFIG_DUMMY_IRQ is not set
 # CONFIG_PHANTOM is not set
@@ -3846,6 +3849,7 @@ CONFIG_HW_RANDOM_ROCKCHIP=y
 # CONFIG_APPLICOM is not set
 # CONFIG_DEVMEM is not set
 CONFIG_DEVPORT=y
+CONFIG_RASPBERRYPI_GPIOMEM=y
 CONFIG_TCG_TPM=y
 # CONFIG_TCG_TPM2_HMAC is not set
 CONFIG_HW_RANDOM_TPM=y
@@ -4154,6 +4158,8 @@ CONFIG_PINCTRL_SINGLE=y
 CONFIG_PINCTRL_ZYNQMP=y
 # CONFIG_PINCTRL_OWL is not set
 CONFIG_PINCTRL_BCM2835=y
+CONFIG_PINCTRL_BCM2712=y
+CONFIG_PINCTRL_RP1=y
 CONFIG_PINCTRL_IPROC_GPIO=y
 CONFIG_PINCTRL_NS2_MUX=y
 # CONFIG_PINCTRL_AS370 is not set
@@ -4332,6 +4338,7 @@ CONFIG_GPIO_GENERIC=y
 # CONFIG_GPIO_AMDPT is not set
 CONFIG_GPIO_RASPBERRYPI_EXP=y
 CONFIG_GPIO_BCM_XGS_IPROC=y
+CONFIG_GPIO_BCM_VIRT=y
 CONFIG_GPIO_BRCMSTB=y
 # CONFIG_GPIO_CADENCE is not set
 # CONFIG_GPIO_DAVINCI is not set
@@ -4741,7 +4748,7 @@ CONFIG_AMLOGIC_THERMAL=y
 # Broadcom thermal drivers
 #
 CONFIG_BCM2711_THERMAL=y
-# CONFIG_BCM2835_THERMAL is not set
+CONFIG_BCM2835_THERMAL=y
 # CONFIG_BRCMSTB_THERMAL is not set
 CONFIG_BCM_NS_THERMAL=y
 CONFIG_BCM_SR_THERMAL=y
@@ -4935,6 +4942,8 @@ CONFIG_MFD_RK8XX_SPI=y
 # CONFIG_MFD_STMPE is not set
 CONFIG_MFD_SUN6I_PRCM=y
 CONFIG_MFD_SYSCON=y
+CONFIG_MFD_RP1=y
+CONFIG_MFD_RASPBERRYPI_POE_HAT=y
 # CONFIG_MFD_TI_AM335X_TSCADC is not set
 # CONFIG_MFD_LP3943 is not set
 # CONFIG_MFD_LP8788 is not set
@@ -7220,6 +7229,7 @@ CONFIG_RTC_INTF_DEV=y
 # CONFIG_RTC_DRV_ABEOZ9 is not set
 # CONFIG_RTC_DRV_ABX80X is not set
 CONFIG_RTC_DRV_BRCMSTB=y
+CONFIG_RTC_DRV_RPI=y
 CONFIG_RTC_DRV_DS1307=y
 # CONFIG_RTC_DRV_DS1307_CENTURY is not set
 # CONFIG_RTC_DRV_DS1374 is not set
@@ -7572,6 +7582,8 @@ CONFIG_COMMON_CLK_SCPI=y
 # CONFIG_COMMON_CLK_SI544 is not set
 # CONFIG_COMMON_CLK_SI570 is not set
 CONFIG_COMMON_CLK_BM1880=y
+CONFIG_COMMON_CLK_RP1=y
+CONFIG_COMMON_CLK_RP1_SDIO=y
 # CONFIG_COMMON_CLK_CDCE706 is not set
 # CONFIG_COMMON_CLK_CDCE925 is not set
 CONFIG_COMMON_CLK_CS2000_CP=y
@@ -8010,6 +8022,7 @@ CONFIG_ROCKCHIP_MBOX=y
 CONFIG_PCC=y
 # CONFIG_ALTERA_MBOX is not set
 CONFIG_BCM2835_MBOX=y
+CONFIG_MBOX_RP1=y
 CONFIG_TI_MESSAGE_MANAGER=y
 CONFIG_HI3660_MBOX=y
 CONFIG_HI6220_MBOX=y
@@ -8963,11 +8976,13 @@ CONFIG_PWM=y
 CONFIG_PWM_BCM2835=y
 CONFIG_PWM_BCM_IPROC=y
 # CONFIG_PWM_BERLIN is not set
-# CONFIG_PWM_BRCMSTB is not set
+CONFIG_PWM_BRCMSTB=y
 # CONFIG_PWM_CLK is not set
 # CONFIG_PWM_DWC is not set
 # CONFIG_PWM_FSL_FTM is not set
-# CONFIG_PWM_GPIO is not set
+CONFIG_PWM_GPIO=y
+CONFIG_PWM_RP1=y
+CONFIG_PWM_PIO_RP1=y
 # CONFIG_PWM_HIBVT is not set
 # CONFIG_PWM_IMX1 is not set
 # CONFIG_PWM_IMX27 is not set
@@ -9003,7 +9018,8 @@ CONFIG_ARM_GIC_V3_ITS=y
 CONFIG_ARM_GIC_V5=y
 CONFIG_IRQ_MSI_LIB=y
 # CONFIG_AL_FIC is not set
-CONFIG_BCM2712_MIP=m
+CONFIG_BCM2712_MIP=y
+CONFIG_BCM2712_IOMMU=y
 CONFIG_BCM7038_L1_IRQ=y
 CONFIG_BCM7120_L2_IRQ=y
 CONFIG_BRCMSTB_L2_IRQ=y
@@ -9258,6 +9274,7 @@ CONFIG_NVMEM_LAYOUTS=y
 # end of Layout Types
 
 CONFIG_NVMEM_BCM_OCOTP=y
+CONFIG_NVMEM_RASPBERRYPI_OTP=y
 # CONFIG_NVMEM_IMX_IIM is not set
 # CONFIG_NVMEM_IMX_OCOTP is not set
 # CONFIG_NVMEM_IMX_OCOTP_ELE is not set
diff --git a/kernel/prepare/pkg.yaml b/kernel/prepare/pkg.yaml
index 6408110..3e166ad 100644
--- a/kernel/prepare/pkg.yaml
+++ b/kernel/prepare/pkg.yaml
@@ -5,8 +5,8 @@ dependencies:
   - stage: base
 steps:
   - sources:
-      - url: https://cdn.kernel.org/pub/linux/kernel/v{{ regexReplaceAll "(\\d+)(.\\d+)(\\.\\d+)?$" .linux_version "${1}" }}.x/linux-{{ .linux_version }}.tar.xz
-        destination: linux.tar.xz
+      - url: https://github.com/raspberrypi/linux/archive/refs/tags/{{ .linux_version }}.tar.gz
+        destination: linux.tar.gz
         sha256: "{{ .linux_sha256 }}"
         sha512: "{{ .linux_sha512 }}"
       - url: https://github.com/a13xp0p0v/kernel-hardening-checker/archive/{{ .kspp_ref }}.tar.gz
@@ -18,7 +18,7 @@ steps:
     prepare:
       - |
         mkdir -p /src
-        tar -xJf linux.tar.xz --strip-components=1 -C /src
+        tar -xzf linux.tar.gz --strip-components=1 -C /src
 
         cd /src
         make mrproper
-- 
2.52.0

